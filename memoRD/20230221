putty.error
no supported authenication methods available(sever sent:publickey)
サポートされている認証方法がありません (送信されたサーバー: 公開鍵)

マシンに公開鍵と秘密鍵を作成
VPSにwindowsマシンの公開鍵を渡す
puttyをクライアントとしてサーバに接続
puttyにubuntuでログインしようとすると以下のerror
No supported authenication methods avaliable(sever sent:publickey)
鍵認証でSSH接続できない状態 

原因究明のためにやったこと
$ssh -l linuser 153.120.41.188
でSSHクライアントのログを確認(ssh_client_log参照)
ホスト認証→SSHサーバに接続まではできているが、これ以降、以下のerror
pubkey_prepare: ssh_get_authentication_socket: No such file or directory
・・・
Permission denied (publickey)
結果的に鍵認証に失敗している

pubkey_prepare: ssh_get_authentication_socket: No such file or directory
解決のため、↑で調べても未解決のものしか出てこなくて躓く
ただ、「windowsではなく、macから同様の鍵認証でssh接続したところできた」という記事があったので
仮想マシン上のubuntuで実行してみようとした
時間かかりそうなのでapacheにすすんだ

apacheのインストールerror？
no vm guests are running outdated hypervisor binaries on this host
このホストで古いハイパーバイザー バイナリを実行している VM ゲストはいません
→wsl2の仕様の問題らしく、とりあえず無視して大丈夫っぽい
その後、正常にインストールできたかどうかufwアプリケーションプロファイル一覧を表示させようとしたが、
文字化けしてしまってerrorの内容が見えなかった


以前，文字化けするので
vi ~/.bashrc
を開き、文末に
case $TERM in
      linux) LANG=C ;;
      *)       LANG=ja_JP.UTF-8;;
esac
を挿入した
元の文字コードを調べ忘れたのだが、とりあえず
echo $LANG
を実行すると
ja_JP,UTF-8
となっており、うまく反映されており、文字化けしなくなったが、
後ほど別のコマンドを入力した際にまた文字化けしていた。。
サーバを再起動させると
echo $LANG →C
になっていた。
https://www.t3a.jp/blog/infrastructure/ubuntu-text-garbled/
を元に再度ja_JP,UTF-8に変更した
（一度rootにログインする必要あり）
rootにログイン:sudo su -
が、rootをログアウトしてubuntuにログインすると再びcになっていた


解決?
GUIではLANG=ja_JP.UTF-8でokだが，実機コンソールでは文字化けの原因になってしまうらしい
（GUIのコンソールでは日本語のままで正常に動くらしい）
sudo LANG=C apt update
で英語表記にした
が、まだ文字化けしている
localeで言語関連の環境変数の一覧を表示したところ、
LANGUAGEだけjap_JP:jaになっていた。。これのせいかな？
LANGUAGE=C
を実行→文字化け解消！
LANGのみならず、LANGUAGEもCに変更する必要があった
参考https://eng-entrance.com/linux-localization-lang

ufw（Uncomplicated FireWall）とは、Linuxの「Netfilter」によるファイアウォールを管理して操作するためのiptablesをラッパーした機能のことです。

もう少しわかり易く言うなら、Linuxにはパケットフィルタリング(ファイアウォール)やNATを実現するための「Netfilter」という機能を標準で備えています。
これを操作・管理するためのツールとしてiptablesというものがあり、iptablesによって非常に細かい設定が行えます。

sudo ufw status
inactive
sudo ufw enable 
active

Apache2導入
https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-ubuntu-20-04-ja
https://elec-hobby.com/vps-vol-03-apache/
ディレクトリ表示のコマンド
https://webkaru.net/linux/ls-command/
パーミッションの読み方
https://qiita.com/shisama/items/5f4c4fa768642aad9e06

Apache
ドメイン名でアクセスできない
やってみたこと

サーバのipアドレスを
sudo nano /etc/apache2/sites-available/test_domain.conf
の*:80の部分にべた貼りした
→変わらない
153.120.41.188:80
にしてみた
→変わらない

https://xtech.nikkei.com/it/article/COLUMN/20061031/252340/
を試してみる
cat では画面に収まりきらないのでlessコマンドなどを使う
https://go-journey.club/archives/14030
とかも使えそう
https://httpd.apache.org/docs/2.4/ja/dns-caveats.html
↑詳しい
Apache が設定ファイルを読み込むときに DNS を使用する必要がないようにするべきらしい
信頼性の問題などがあるらしい
testdomain.confにIPアドレスが含まれていない場合，ApacheはDNSを利用して*:80部分を見つけることになる(ドメインベース)
*:80部分にサーバのIPアドレスApacheはDNS逆引きを使用してバーチャルホストのServerNameを見つける(IPアドレスベース)
IPアドレスベースだとおおむね動作するらしい(アドレスが変更される可能性が高いなら非推奨？)
ドメインベースの場合はIPアドレスを探索し，IPアドレスベースの場合はドメインを探索する
どっちにしてもドメインとIPアドレスが紐づけられていないと動作しない
httpd.confを確認
https://www.javadrive.jp/apache/ini/index11.html

DNSサーバの設定
/etc/resolv.conf
host名からipアドレスを調べる設定を行う

namesever 127.0.0.53
options edns0 trust-ad
seach .
となっていた
DHCPを使ってネットワークの設定を取得すると自動生成されるファイルで
本来
namesever DNSサーバのip(DHCPサーバが自動で引っ張ってくるDNSサーバ)
domain　*localdomain 
*コンピュータが所属するドメイン名にするとホスト名だけでそのホストにアクセスできるようになるらしい
search domainを複数指定できる

nameseverが不適切だと名前解決に対する動作がおかしくなるそう
https://linuc.org/study/knowledge/507/

$nslookup test_domain 127.0.0.53
dnsサーバに名前解決を問い合わせたがtest_domainなんかないと言われた
dnsサーバの設定を行う必要があることが判明

sudo cat /etc/resolv.confで
nameseresolv.confとは、リゾルバの設定ファイルになります。

リゾルバとは、DNSサーバにドメイン名で問い合わせを行いIPアドレスを調べたり、
その逆でIPアドレスで問い合わせを行いドメイン名を調べるソフトウェアになります。
domain行とsearch行はどちらかを指定
両方指定するとまずは上の行に問い合わせて，応答がない場合下の行に問い合わせる


疑問
ssh認証ではマシンの公開鍵をサーバに渡し、サーバが公開鍵をつかって暗号化したものを受信し
マシンの秘密鍵で復号して送信し、サーバ側で暗号前のデータと一致していれば認証するもの
だと認識しているが、
https://www.server-world.info/query?os=Ubuntu_22.04&p=ssh&f=4
では「サーバの秘密鍵をマシンに登録する」という工程があり、理解できず中断してしまった。。
